<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Timeline Editor Pro</title>
<style>
  /* -------------------
     Core Variables
     ------------------- */
  :root {
    --font-stack: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    
    /* Dark Theme (Default) */
    --bg-app: #0f1115;
    --bg-blob: #4f46e5;
    
    --glass-surf: rgba(30, 35, 45, 0.7);
    --glass-border: rgba(255, 255, 255, 0.08);
    --glass-highlight: rgba(255, 255, 255, 0.03);
    
    --text-main: #f1f5f9;
    --text-muted: #94a3b8;
    
    --accent: #6366f1;
    --accent-hover: #818cf8;
    
    --input-bg: rgba(0, 0, 0, 0.2);
    --radius: 16px;
    --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  body[data-theme="light"] {
    --bg-app: #f0f2f5;
    --bg-blob: #60a5fa;
    
    --glass-surf: rgba(255, 255, 255, 0.75);
    --glass-border: rgba(255, 255, 255, 0.4);
    --glass-highlight: rgba(255, 255, 255, 0.5);
    
    --text-main: #1e293b;
    --text-muted: #64748b;
    
    --accent: #3b82f6;
    --accent-hover: #60a5fa;
    
    --input-bg: rgba(255, 255, 255, 0.5);
    --shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
  }

  /* -------------------
     Reset & Base
     ------------------- */
  * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
  body {
    margin: 0; padding: 0;
    font-family: var(--font-stack);
    background-color: var(--bg-app);
    color: var(--text-main);
    min-height: 100vh;
    overflow-x: hidden;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  /* Background Ambient Blobs */
  .ambient-light {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1; pointer-events: none; overflow: hidden;
  }
  .blob {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.4;
    animation: float 10s infinite ease-in-out;
  }
  .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: var(--bg-blob); }
  .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: var(--accent); animation-delay: -5s; }

  @keyframes float {
    0%, 100% { transform: translate(0, 0); }
    50% { transform: translate(20px, 40px); }
  }

  /* -------------------
     Layout
     ------------------- */
  .app-container {
    max-width: 1800px;
    margin: 0 auto;
    padding: 20px;
    display: grid;
    /* List takes space, Editor is fixed width */
    grid-template-columns: 1fr 450px;
    gap: 24px;
    height: 100vh;
    max-height: 100vh;
  }

  .col-right {
    display: flex;
    flex-direction: column;
    gap: 16px;
    height: 100%;
    overflow: hidden; 
  }

  /* Header inside sidebar on Desktop */
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding-bottom: 20px;
  }

  .logo-area {
    display: flex; align-items: center; gap: 12px;
  }
  .logo-icon {
    width: 40px; height: 40px; border-radius: 10px;
    background: linear-gradient(122deg,rgb(255, 255, 255) 10%, rgb(245, 140, 83) 20%, rgb(245, 140, 83) 30%, rgb(255, 255, 255) 50%, rgb(245, 140, 83) 70%, rgb(245, 140, 83) 80%, rgb(255, 255, 255) 90%);
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: bold; font-size: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  h1 { font-size: 18px; margin: 0; font-weight: 700; line-height: 1.2; }
  .subtitle { font-size: 12px; color: var(--text-muted); margin: 0; }

  /* -------------------
     Components: Panels (Glassmorphism)
     ------------------- */
  .panel {
    background: var(--glass-surf);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    display: flex; flex-direction: column;
    overflow: hidden;
    position: relative;
  }
  
  .panel::before {
    content:''; position: absolute; inset: 0;
    background: linear-gradient(180deg, var(--glass-highlight) 0%, transparent 100%);
    pointer-events: none;
    z-index: 0;
  }

  /* -------------------
     Sidebar (List Area)
     ------------------- */
  .sidebar {
    display: flex; flex-direction: column;
    height: 100%;
    overflow: hidden;
  }
  
  /* Container for the scrollable list and the button at the bottom */
  .list-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .toolbar {
    display: flex; flex-wrap: wrap; gap: 8px;
    align-items: center;
  }

  /* List Area */
  .list-container {
    flex: 1; /* Allow list to take up available space */
    overflow-y: auto;
    padding: 12px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 12px;
    align-content: start;
    
    /* Custom Scrollbar */
    scrollbar-width: thin;
    scrollbar-color: var(--accent) transparent;
  }
  .list-container::-webkit-scrollbar { width: 4px; }
  .list-container::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }

  /* Episode Item */
  .ep-item {
    display: flex; gap: 12px; padding: 12px;
    background: rgba(255,255,255,0.02);
    border: 1px solid transparent;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative; z-index: 1;
    height: 100%;
  }
  .ep-item:hover { background: rgba(255,255,255,0.05); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  .ep-item.active {
    background: var(--accent);
    color: #fff;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    border-color: rgba(255,255,255,0.2);
  }
  .ep-item.active .ep-desc { color: rgba(255,255,255,0.8); }

  .ep-thumb {
    width: 80px; height: 56px; border-radius: 8px;
    background: #000; object-fit: cover; flex-shrink: 0;
  }
  .ep-info { flex: 1; min-width: 0; display: flex; flex-direction: column; }
  .ep-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; line-height: 1.3; }
  .ep-desc { font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* New Episode Button (Bottom of List) */
  #btn-add-wrapper {
    padding: 16px 0 0 0;
    flex-shrink: 0;
  }

  /* -------------------
     Controls Panel (Top Right) - SLIDE-UP EFFECT
     ------------------- */
  .controls-panel {
    flex-shrink: 0;
    padding: 16px;
    display: flex; flex-wrap: wrap; gap: 10px;
    align-items: center;
    justify-content: space-between;
    transition: all 0.3s ease-in-out; /* Smooth transition for slide */
    transform: translateY(0);
    position: relative; 
    z-index: 10;
  }
  
  /* Collapsed state class for slide-up */
  .controls-panel.collapsed {
    max-height: 0;
    padding-top: 0;
    padding-bottom: 0;
    opacity: 0;
    /* Slide up off screen and remove height */
    transform: translateY(-100%); 
    margin-bottom: -16px; /* Negate the gap from col-right to allow editor to fill space */
    overflow: hidden;
    border: none;
    pointer-events: none; /* Disable interaction when hidden */
  }

  /* -------------------
     Editor Area
     ------------------- */
  .editor-panel {
    flex: 1; /* Grow to fill space */
    min-height: 0; 
    padding: 0;
    display: flex; flex-direction: column;
  }

  .editor-scroll {
    flex: 1; overflow-y: auto; padding: 24px;
  }

  .editor-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 24px;
    border-bottom: 1px solid var(--glass-border);
    background: rgba(0,0,0,0.1); 
    flex-shrink: 0;
  }
  .editor-title-area { display: flex; align-items: center; gap: 10px; }
  .editor-title { font-size: 16px; font-weight: 700; }

  /* Tool toggle button (for collapse controls) */
  .tool-toggle {
    width: 32px; height: 32px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; color: var(--text-muted);
    background: rgba(255,255,255,0.05);
    transition: all 0.2s;
  }
  .tool-toggle:hover { background: rgba(255,255,255,0.1); color: var(--text-main); }
  .tool-toggle.active { color: white; background: var(--accent); } /* Active state for collapse button */
  .tool-toggle svg { transform-origin: center; transition: transform 0.3s; }
  .tool-toggle.active svg { transform: rotate(180deg); } /* Arrow rotation */


  /* Form Grid */
  .form-grid {
    display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px;
  }
  .col-12 { grid-column: span 12; }
  .col-6 { grid-column: span 6; }
  .col-4 { grid-column: span 4; }

  label {
    display: block; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--text-muted); margin-bottom: 4px; font-weight: 600;
  }
  
  input, textarea, select {
    width: 100%;
    background: var(--input-bg);
    border: 1px solid var(--glass-border);
    color: var(--text-main);
    padding: 8px 12px;
    border-radius: 8px;
    font-family: inherit; font-size: 13px;
    transition: all 0.2s;
  }
  input:focus, textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
  }
  textarea { min-height: 60px; resize: vertical; }

  .section-label {
    grid-column: span 12;
    margin-top: 12px; margin-bottom: 4px;
    font-size: 12px; font-weight: bold; color: var(--accent);
    display: flex; align-items: center; gap: 8px;
  }
  .section-label::after { content:''; flex:1; height:1px; background: var(--glass-border); }

  /* Buttons */
  .btn {
    border: none; background: rgba(255,255,255,0.1);
    color: var(--text-main);
    padding: 8px 14px; border-radius: 8px;
    cursor: pointer; font-size: 13px; font-weight: 600;
    transition: all 0.2s;
    display: inline-flex; align-items: center; gap: 6px; white-space: nowrap;
  }
  .btn:hover { background: rgba(255,255,255,0.2); }
  .btn:active { transform: scale(0.96); }
  
  .btn.primary { background: var(--accent); color: white; }
  .btn.primary:hover { background: var(--accent-hover); }
  
  .btn.danger { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
  .btn.danger:hover { background: rgba(239, 68, 68, 0.4); }

  .btn-group { display: flex; gap: 8px; }

  /* -------------------
     Mobile Response
     ------------------- */
  @media (max-width: 900px) {
    .app-container {
      grid-template-columns: 1fr;
      padding: 10px;
      height: auto; min-height: 100vh;
      display: block; 
    }
    .col-right { height: auto; margin-top: 20px; }
    .sidebar { height: auto; max-height: 60vh; margin-bottom: 0; }
    .list-wrapper { max-height: 50vh; }
    .list-container { max-height: 40vh; display: block; } 
    .ep-item { margin-bottom: 8px; height: auto; }
    .editor-panel { min-height: 70vh; }
    /* Mobile: Controls should always be visible and in flow */
    .controls-panel.collapsed { max-height: none !important; opacity: 1 !important; transform: none !important; margin-bottom: 16px; border: 1px solid var(--glass-border); pointer-events: auto;}
    .tool-toggle { display: none; } /* Hide collapse on mobile */
  }

  /* Toggle Switch */
  .toggle-switch {
    background: rgba(0,0,0,0.2);
    border-radius: 20px;
    padding: 2px;
    display: inline-flex;
    border: 1px solid var(--glass-border);
  }
  .toggle-opt {
    padding: 4px 10px;
    border-radius: 16px;
    font-size: 11px;
    font-weight: bold;
    cursor: pointer;
    color: var(--text-muted);
  }
  .toggle-opt.active {
    background: var(--glass-border);
    color: var(--text-main);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  /* Status Bar */
  .status-bar {
    position: fixed; bottom: 20px; right: 20px;
    background: var(--glass-surf);
    padding: 8px 16px; border-radius: 20px;
    font-size: 12px; color: var(--text-muted);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(10px);
    z-index: 100;
    display: flex; align-items: center; gap: 8px;
    animation: slideUp 0.3s ease-out;
  }
  @keyframes slideUp { from{transform:translateY(20px);opacity:0;} to{transform:translateY(0);opacity:1;} }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
  .status-dot.success { background: #10b981; }
  .status-dot.error { background: #ef4444; }
  .status-dot.loading { background: #f59e0b; animation: pulse 1s infinite; }
  @keyframes pulse { 0%{opacity:1} 50%{opacity:0.4} 100%{opacity:1} }

  /* --- Radio Button Group Style --- */
  .radio-group {
    display: flex; gap: 8px;
    background: var(--input-bg);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    padding: 6px;
  }

  .custom-radio {
    /* Hide the default radio button */
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .radio-group label {
    /* Style the label to look like a button */
    display: block;
    cursor: pointer;
    flex: 1;
    text-align: center;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 13px;
    color: var(--text-muted);
    background: transparent;
    transition: all 0.2s;
    /* Reset label specific styles from general label rule */
    text-transform: none; /* Keep normal case for radio labels */
    letter-spacing: normal;
    font-weight: 500;
    margin-bottom: 0;
  }
  
  .radio-group label:hover {
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-main);
  }

  /* Style when checked */
  .custom-radio:checked + label {
    background: var(--accent);
    color: white;
    box-shadow: 0 2px 5px rgba(99, 102, 241, 0.2);
  }

</style>
</head>
<body data-theme="dark">

<div class="ambient-light">
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>
</div>

<div class="app-container">
  
  <!-- LEFT: Sidebar (LIST) -->
  <aside class="sidebar">
    <header>
      <div class="logo-area">
        <div class="logo-icon"><img src="https://raw.githubusercontent.com/zavorateam/zavorateam.github.io/refs/heads/main/assets/favicon.svg"></div>
        <div>
          <h1 id="ui-title">Editor Pro</h1>
          <p class="subtitle" id="ui-sub">JSON Management</p>
        </div>
      </div>
      
      <!-- View Controls -->
      <div class="toolbar">
        <div class="toggle-switch">
          <div class="toggle-opt active" id="lang-ru">RU</div>
          <div class="toggle-opt" id="lang-en">EN</div>
        </div>
        <div class="toggle-switch">
          <div class="toggle-opt active" id="theme-dark">Moon</div>
          <div class="toggle-opt" id="theme-light">Sun</div>
        </div>
      </div>
    </header>

    <div class="list-wrapper panel">
        <div class="list-container" id="list-container">
            <!-- List items injected here -->
            <div style="padding:20px; text-align:center; color:var(--text-muted);">
                No data loaded
            </div>
        </div>
        <div id="btn-add-wrapper" style="padding: 16px; border-top: 1px solid var(--glass-border);">
            <!-- Button moved here -->
            <button id="btn-add" class="btn primary small" style="width:100%;">+ New Episode</button>
        </div>
    </div>
  </aside>

  <!-- RIGHT: Editor Column (Narrower) -->
  <div class="col-right">
    
    <!-- Controls Panel (Collapsible) -->
    <div class="panel controls-panel" id="controls-panel">
      <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
          <div class="btn-group">
            <button id="btn-load" class="btn small">Load Cloud</button>
            <button id="btn-save" class="btn small primary">Save Cloud</button>
          </div>
          <div class="btn-group">
            <button id="btn-import" class="btn small">Import</button>
            <button id="btn-export" class="btn small primary">Export</button>
          </div>
          <!-- Toggle button moved here and styled to control this panel -->
          <div class="tool-toggle active" id="toggle-controls" title="Toggle Controls">
            <!-- Arrow Down/Up Icon -->
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-up-down"><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg>
          </div>
      </div>
    </div>

    <!-- Main Editor -->
    <main class="panel editor-panel" id="editor-view">
      <div class="editor-header">
        <div class="editor-title-area">
          <div class="editor-title" id="lbl-editor">Editor</div>
        </div>
        <div class="btn-group">
          <button id="btn-dup" class="btn small">Dup</button>
          <button id="btn-del" class="btn small danger">Del</button>
        </div>
      </div>

      <div class="editor-scroll">
        <div id="form-container" class="form-grid">
          
          <!-- Meta Section -->
          <div class="section-label" id="sec-date">Date & Meta</div>
          <div class="col-4">
            <label id="lbl-year">Year</label>
            <input type="number" id="inp-year" placeholder="2023">
          </div>
          <div class="col-4">
            <label id="lbl-month">Month</label>
            <input type="number" id="inp-month" placeholder="1-12">
          </div>
          <div class="col-4">
            <label id="lbl-week">Week</label>
            <input type="number" id="inp-week" placeholder="1-52">
          </div>

          <div class="col-4">
            <label id="lbl-rating">Rating (0-10)</label>
            <input type="number" id="inp-rating" placeholder="7.5" step="0.1" min="0" max="10">
          </div>
          <div class="col-8">
            </div>

          <div class="col-6">
            <label id="lbl-production-group">Production Type</label>
            <div class="radio-group" id="production-group">
              <input type="radio" id="prod-domestic" name="production" value="domestic" class="custom-radio">
              <label for="prod-domestic" id="lbl-prod-domestic">Domestic</label>
              <input type="radio" id="prod-foreign" name="production" value="foreign" class="custom-radio">
              <label for="prod-foreign" id="lbl-prod-foreign">Foreign</label>
            </div>
          </div>
          
          <div class="col-6">
            <label id="lbl-media-group">Media Type</label>
            <div class="radio-group" id="media-group">
              <input type="radio" id="type-movie" name="media_type" value="movie" class="custom-radio">
              <label for="type-movie" id="lbl-type-movie">Movie</label>
              <input type="radio" id="type-series" name="media_type" value="series" class="custom-radio">
              <label for="type-series" id="lbl-type-series">Series</label>
            </div>
          </div>

          <div class="section-label" id="sec-ru">Content (RU - Default)</div>
          
          <!-- New Fields: Length (Col 4) and Cast/Crew (Col 12) -->
          <div class="col-4">
            <label id="lbl-length">Length (Days)</label>
            <input type="number" id="inp-length" placeholder="1-1000">
          </div>
          <div class="col-12">
            <label id="lbl-authors">Authors</label>
            <input type="text" id="inp-authors" placeholder="Author 1, Author 2">
          </div>
          <div class="col-12">
            <label id="lbl-actors">Actors</label>
            <input type="text" id="inp-actors" placeholder="Actor 1, Actor 2">
          </div>
          <div class="col-12">
            <label id="lbl-director">Director</label>
            <input type="text" id="inp-director" placeholder="Director Name">
          </div>

          <!-- Content RU Section -->
          <div class="section-label" id="sec-ru">Content (RU - Default)</div>
          <div class="col-12">
            <label id="lbl-title">Title (RU)</label>
            <input type="text" id="inp-title">
          </div>
          <div class="col-12">
            <label id="lbl-desc">Description (RU)</label>
            <textarea id="inp-desc"></textarea>
          </div>

          <!-- Content EN Section -->
          <div class="section-label" id="sec-en">Content (EN - International)</div>
          <div class="col-12">
            <label id="lbl-title-en">Title (EN)</label>
            <input type="text" id="inp-title-en" placeholder="English Title">
          </div>
          <div class="col-12">
            <label id="lbl-desc-en">Description (EN)</label>
            <textarea id="inp-desc-en" placeholder="English description text..."></textarea>
          </div>

          <!-- Media Section -->
          <div class="section-label" id="sec-media">Media & Links</div>
          <div class="col-6">
            <label id="lbl-preview">Preview Image URL</label>
            <input type="text" id="inp-preview">
          </div>
          <div class="col-6">
            <label id="lbl-video">Video Link</label>
            <input type="text" id="inp-video">
          </div>
          <div class="col-12">
            <label id="lbl-history">History Source Link</label>
            <input type="text" id="inp-history">
          </div>

          <!-- Custom Fields (Text 1/2) -->
          <div class="section-label" id="sec-custom">Custom Fields</div>
          <div class="col-6">
            <label id="lbl-f1">Field 1</label>
            <input type="text" id="inp-f1">
          </div>
          <div class="col-6">
            <label id="lbl-f2">Field 2</label>
            <input type="text" id="inp-f2">
          </div>

        </div>
      </div>
    </main>
  </div>
</div>

<!-- Status Toast -->
<div id="status-toast" class="status-bar" style="display:none;">
  <div id="status-dot" class="status-dot"></div>
  <span id="status-text">Ready</span>
</div>

<!-- Hidden File Input -->
<input type="file" id="file-input" style="display:none" accept=".json">

<script>
/* -------------------------------------------
   Configuration & State
   ------------------------------------------- */
const CONFIG = {
  gistIdDefault: 'b973e400c1b9bea04411240195566b68', // Example ID, replace with actual ID if known
  fileName: 'timeline-data.json'
};

const STATE = {
  data: [],
  selectedIdx: -1,
  locale: 'ru',
  theme: 'dark',
  isControlsCollapsed: false // New state for controls panel
};

const UI = {
  ru: {
    title: 'Редактор Timeline',
    sub: 'Управление базой фильмов',
    load: 'Загрузить', save: 'Сохранить', import: 'Импорт', export: 'Экспорт',
    add: '+ Новый Эпизод', editor: 'Редактор',
    
    // Labels
    lblYear:'Год', lblMonth:'Месяц', lblWeek:'Неделя',
    lblTitle:'Заголовок (RU)', lblDesc:'Описание (RU)',
    lblTitleEn:'Заголовок (EN)', lblDescEn:'Описание (EN)',
    lblPreview:'Превью (URL)', lblVideo:'Видео (Ссылка)', lblHistory:'Источник (Ссылка)',
    
    // New Meta Fields
    lblLength: 'Длина (Дни)', lblAuthors: 'Авторы', lblActors: 'Актеры', lblDirector: 'Режиссер',
    lblRating: 'Рейтинг (0-10)',
    lblProductionGroup: 'Производство',
    lblProdDomestic: 'Отечеств.',
    lblProdForeign: 'Заруб.',
    lblMediaGroup: 'Тип Контента',
    lblTypeMovie: 'Фильм',
    lblTypeSeries: 'Сериал',

    // Custom Fields (Translated)
    lblF1: 'Текст 1', lblF2: 'Текст 2',
    
    // Sections (Localization)
    secDate: 'Дата и Мета',
    secRu: 'Контент (RU - Основной)',
    secEn: 'Контент (EN - Перевод)',
    secMedia: 'Медиа и Ссылки',
    secCustom: 'Доп. поля',

    msgSaved: 'Сохранено!', msgErr: 'Ошибка', msgLoad: 'Данные загружены'
  },
  en: {
    title: 'Timeline Editor',
    sub: 'Movie Database Manager',
    load: 'Load Cloud', save: 'Save Cloud', import: 'Import', export: 'Export',
    add: '+ New Episode', editor: 'Editor',
    
    // Labels
    lblYear:'Year', lblMonth:'Month', lblWeek:'Week',
    lblTitle:'Title (RU)', lblDesc:'Description (RU)',
    lblTitleEn:'Title (EN)', lblDescEn:'Description (EN)',
    lblPreview:'Preview (URL)', lblVideo:'Video (Link)', lblHistory:'History (Link)',

    // New Meta Fields
    lblLength: 'Length (Days)', lblAuthors: 'Authors', lblActors: 'Actors', lblDirector: 'Director',
    lblRating: 'Rating (0-10)',
    lblProductionGroup: 'Production Type',
    lblProdDomestic: 'Domestic',
    lblProdForeign: 'Foreign',
    lblMediaGroup: 'Media Type',
    lblTypeMovie: 'Movie',
    lblTypeSeries: 'Series',
    
    // Custom Fields (Translated)
    lblF1: 'Field 1', lblF2: 'Field 2',
    
    // Sections
    secDate: 'Date & Meta',
    secRu: 'Content (RU - Default)',
    secEn: 'Content (EN - International)',
    secMedia: 'Media & Links',
    secCustom: 'Custom Fields',

    msgSaved: 'Saved Successfully!', msgErr: 'Error', msgLoad: 'Data Loaded'
  }
};

/* -------------------------------------------
   Core Logic
   ------------------------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  // Init Theme
  const savedTheme = localStorage.getItem('tl_theme') || 'dark';
  setTheme(savedTheme);

  // Init Locale
  const savedLang = localStorage.getItem('tl_lang') || 'ru';
  setLang(savedLang);

  // Bind Events
  bindEvents();
});

function bindEvents() {
  // Theme Toggle
  document.getElementById('theme-dark').onclick = () => setTheme('dark');
  document.getElementById('theme-light').onclick = () => setTheme('light');

  // Lang Toggle
  document.getElementById('lang-ru').onclick = () => setLang('ru');
  document.getElementById('lang-en').onclick = () => setLang('en');

  // Buttons
  document.getElementById('btn-add').onclick = addEpisode;
  document.getElementById('btn-del').onclick = deleteEpisode;
  document.getElementById('btn-dup').onclick = duplicateEpisode;
  document.getElementById('btn-export').onclick = exportData;
  document.getElementById('btn-import').onclick = () => document.getElementById('file-input').click();
  document.getElementById('file-input').onchange = handleFileUpload;

  // Cloud
  document.getElementById('btn-load').onclick = loadFromGist;
  document.getElementById('btn-save').onclick = saveToGist;
  
  // Controls Toggle (Slide-up logic)
  document.getElementById('toggle-controls').onclick = toggleControlsPanel;

  // Form Inputs (Auto-save to state)
  const inputs = document.querySelectorAll('input, textarea');
  inputs.forEach(el => {
    el.addEventListener('input', updateStateFromForm);
  });
}

/* Replace your old toggleControlsPanel() with this */
function toggleControlsPanel() {
  STATE.isControlsCollapsed = !STATE.isControlsCollapsed;
  const panel = document.getElementById('controls-panel');
  const toggleBtn = document.getElementById('toggle-controls');

  // helper: find existing handle
  let handle = document.querySelector('.toggle-controls-handle');

  if (STATE.isControlsCollapsed) {
    // collapse panel
    panel.classList.add('collapsed');
    toggleBtn && toggleBtn.classList.add('active');

    // create the top handle if not exists
    if (!handle) {
      handle = document.createElement('button');
      handle.className = 'toggle-controls-handle';
      handle.setAttribute('type', 'button');
      handle.setAttribute('aria-label', 'Open controls');
      handle.style.cssText = [
        'color:var(--text-muted)',
        'position:fixed',
        'top:-30px',
        'right:15em',
        'transform:translate(-50%,-50%)', /* start hidden above the border */
        'margin-top:8px',
        'z-index:9999',
        'width:44px',
        'height:44px',
        'border-radius:8px',
        'display:flex',
        'align-items:center',
        'justify-content:center',
        'background:var(--glass-surf)',
        'border:1px solid var(--glass-border)',
        'box-shadow:0 6px 18px rgba(0,0,0,0.12)',
        'cursor:pointer',
        'opacity:0',
        'transition:transform .22s ease, opacity .18s ease'
      ].join(';');

      // chevron down svg
      handle.innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round"
             stroke-linejoin="round" aria-hidden="true">
          <path d="M6 9l6 6 6-6"></path>
        </svg>
      `;

      // click opens the panel
      handle.addEventListener('click', (ev) => {
        ev.stopPropagation();
        // expand via same function
        toggleControlsPanel();
      });

      document.body.appendChild(handle);

      // let browser paint initial state, then slide it down a bit
      requestAnimationFrame(() => {
        handle.style.transform = 'translate(-50%, 10px)'; // visible just below top border
        handle.style.opacity = '1';
      });
    } else {
      // if exists but was hidden, show it
      handle.style.transform = 'translate(-50%, 10px)';
      handle.style.opacity = '1';
    }

  } else {
    // expand panel
    panel.classList.remove('collapsed');
    toggleBtn && toggleBtn.classList.remove('active');

    // hide/remove handle with a small animation
    if (handle) {
      handle.style.opacity = '0';
      handle.style.transform = 'translate(-50%,-50%)'; // move back up
      // remove after transition
      setTimeout(() => {
        if (handle && handle.parentNode) handle.parentNode.removeChild(handle);
      }, 220);
    }
  }
}


/* -------------------------------------------
   UI Functions
   ------------------------------------------- */
function setTheme(t) {
  STATE.theme = t;
  document.body.setAttribute('data-theme', t);
  localStorage.setItem('tl_theme', t);
  document.getElementById('theme-dark').className = `toggle-opt ${t==='dark'?'active':''}`;
  document.getElementById('theme-light').className = `toggle-opt ${t==='light'?'active':''}`;
}

function setLang(l) {
  STATE.locale = l;
  localStorage.setItem('tl_lang', l);
  document.getElementById('lang-ru').className = `toggle-opt ${l==='ru'?'active':''}`;
  document.getElementById('lang-en').className = `toggle-opt ${l==='en'?'active':''}`;
  
  // Update Text
  const dict = UI[l];
  document.getElementById('ui-title').innerText = dict.title;
  document.getElementById('ui-sub').innerText = dict.sub;
  document.getElementById('btn-load').innerText = dict.load;
  document.getElementById('btn-save').innerText = dict.save;
  document.getElementById('btn-import').innerText = dict.import;
  document.getElementById('btn-export').innerText = dict.export;
  document.getElementById('btn-add').innerText = dict.add;
  document.getElementById('lbl-editor').innerText = dict.editor;
  
  // Labels
  document.getElementById('lbl-year').innerText = dict.lblYear;
  document.getElementById('lbl-month').innerText = dict.lblMonth;
  document.getElementById('lbl-week').innerText = dict.lblWeek;
  document.getElementById('lbl-title').innerText = dict.lblTitle;
  document.getElementById('lbl-desc').innerText = dict.lblDesc;
  document.getElementById('lbl-title-en').innerText = dict.lblTitleEn;
  document.getElementById('lbl-desc-en').innerText = dict.lblDescEn;
  document.getElementById('lbl-preview').innerText = dict.lblPreview;
  document.getElementById('lbl-video').innerText = dict.lblVideo;
  document.getElementById('lbl-history').innerText = dict.lblHistory;
  
  // New Labels
  document.getElementById('lbl-length').innerText = dict.lblLength;
  document.getElementById('lbl-authors').innerText = dict.lblAuthors;
  document.getElementById('lbl-actors').innerText = dict.lblActors;
  document.getElementById('lbl-director').innerText = dict.lblDirector;
  document.getElementById('lbl-rating').innerText = dict.lblRating;
  document.getElementById('lbl-production-group').innerText = dict.lblProductionGroup;
  document.getElementById('lbl-prod-domestic').innerText = dict.lblProdDomestic;
  document.getElementById('lbl-prod-foreign').innerText = dict.lblProdForeign;
  document.getElementById('lbl-media-group').innerText = dict.lblMediaGroup;
  document.getElementById('lbl-type-movie').innerText = dict.lblTypeMovie;
  document.getElementById('lbl-type-series').innerText = dict.lblTypeSeries;
  document.getElementById('lbl-f1').innerText = dict.lblF1;
  document.getElementById('lbl-f2').innerText = dict.lblF2;

  // Section Headers
  document.getElementById('sec-date').innerText = dict.secDate;
  document.getElementById('sec-ru').innerText = dict.secRu;
  document.getElementById('sec-en').innerText = dict.secEn;
  document.getElementById('sec-media').innerText = dict.secMedia;
  document.getElementById('sec-custom').innerText = dict.secCustom;

  // Re-render list because titles might change based on language preference
  renderList();
}

function showStatus(text, type='neutral') {
  const el = document.getElementById('status-toast');
  const dot = document.getElementById('status-dot');
  const txt = document.getElementById('status-text');
  
  el.style.display = 'flex';
  txt.innerText = text;
  dot.className = 'status-dot ' + type;
  
  // Hide after 3s if not loading
  if(type !== 'loading') {
    setTimeout(() => { el.style.display = 'none'; }, 3000);
  }
}

/* -------------------------------------------
   Data Logic
   ------------------------------------------- */
function renderList() {
  const container = document.getElementById('list-container');
  container.innerHTML = '';
  
  if(STATE.data.length === 0) {
    container.innerHTML = `<div style="grid-column:1/-1; padding:40px; text-align:center; opacity:0.5;">Empty</div>`;
    return;
  }

  STATE.data.forEach((ep, idx) => {
    const div = document.createElement('div');
    div.className = `ep-item ${idx === STATE.selectedIdx ? 'active' : ''}`;
    div.onclick = () => selectEpisode(idx);
    
    // Smart Title Selection based on Locale
    let displayTitle = ep.title || 'No Title';
    let displayDesc = ep.description || '';
    
    // If EN mode and EN title exists, use it
    if(STATE.locale === 'en' && ep.title_en) {
      displayTitle = ep.title_en;
      displayDesc = ep.description_en || displayDesc;
    }

    div.innerHTML = `
      <img src="${ep.preview || 'https://placehold.co/80x56/333/fff?text=No+Img'}" class="ep-thumb" onerror="this.onerror=null;this.src='https://placehold.co/80x56/333/fff?text=No+Img'">
      <div class="ep-info">
        <div class="ep-title">${escapeHtml(displayTitle)}</div>
        <div class="ep-desc">${escapeHtml(displayDesc)}</div>
      </div>
    `;
    container.appendChild(div);
  });
}

function selectEpisode(idx) {
  STATE.selectedIdx = idx;
  renderList(); // Update active class
  
  const ep = STATE.data[idx];
  if(!ep) return;

  // Bind values
  document.getElementById('inp-year').value = ep.year || '';
  document.getElementById('inp-month').value = ep.month || '';
  document.getElementById('inp-week').value = ep.week || '';
  document.getElementById('inp-length').value = ep.length || '';
  document.getElementById('inp-authors').value = ep.authors || '';
  document.getElementById('inp-actors').value = ep.actors || '';
  document.getElementById('inp-director').value = ep.director || '';

  document.getElementById('inp-rating').value = ep.rating || '';
  
  document.getElementById('inp-title').value = ep.title || '';
  document.getElementById('inp-desc').value = ep.description || '';
  
  // English Fields
  document.getElementById('inp-title-en').value = ep.title_en || '';
  document.getElementById('inp-desc-en').value = ep.description_en || '';
  
  document.getElementById('inp-preview').value = ep.preview || '';
  document.getElementById('inp-video').value = ep.video_link || ep.video || '';
  document.getElementById('inp-history').value = ep.history_link || ep.history || '';
  document.getElementById('inp-f1').value = ep.field1 || '';
  document.getElementById('inp-f2').value = ep.field2 || '';

  const prodVal = ep.production || 'domestic'; // default to domestic
  const prodRadio = document.querySelector(`input[name="production"][value="${prodVal}"]`);
  if(prodRadio) prodRadio.checked = true;

  // Media Type: movie/series
  const mediaVal = ep.media_type || 'movie'; // default to movie
  const mediaRadio = document.querySelector(`input[name="media_type"][value="${mediaVal}"]`);
  if(mediaRadio) mediaRadio.checked = true;
  
  document.getElementById('inp-title').value = ep.title || '';

  // Mobile: Scroll to editor
  if(window.innerWidth < 900) {
    document.getElementById('editor-view').scrollIntoView({behavior: 'smooth'});
  }
}

function updateStateFromForm() {
  if(STATE.selectedIdx === -1) return;
  
  const ep = STATE.data[STATE.selectedIdx];
  ep.year = parseInt(document.getElementById('inp-year').value) || 0;
  ep.month = parseInt(document.getElementById('inp-month').value) || 0;
  ep.week = parseInt(document.getElementById('inp-week').value) || 0;
  ep.length = parseInt(document.getElementById('inp-length').value) || 0;
  ep.authors = document.getElementById('inp-authors').value;
  ep.actors = document.getElementById('inp-actors').value;
  ep.director = document.getElementById('inp-director').value;
  ep.rating = parseFloat(document.getElementById('inp-rating').value) || 0; // <<< NEW
  
  // Radio Buttons: find selected value
  ep.production = document.querySelector('input[name="production"]:checked')?.value || 'domestic'; // <<< NEW
  ep.media_type = document.querySelector('input[name="media_type"]:checked')?.value || 'movie'; // <<< NEW

  ep.title = document.getElementById('inp-title').value;
  ep.description = document.getElementById('inp-desc').value;
  
  // English Fields
  ep.title_en = document.getElementById('inp-title-en').value;
  ep.description_en = document.getElementById('inp-desc-en').value;
  
  ep.preview = document.getElementById('inp-preview').value;
  ep.video_link = document.getElementById('inp-video').value;
  ep.history_link = document.getElementById('inp-history').value;
  ep.field1 = document.getElementById('inp-f1').value;
  ep.field2 = document.getElementById('inp-f2').value;

  renderList(); // Update list item title/desc if changed
}

/* -------------------------------------------
   CRUD
   ------------------------------------------- */
function addEpisode() {
  const newEp = {
    title: 'Новый Эпизод',
    title_en: 'New Episode (EN)',
    year: new Date().getFullYear(),
    month: 1, week: 1, length: 7,
    authors: '', actors: '', director: '',
    rating: 0,
    production: 'domestic',
    media_type: 'movie',
    description: '', description_en: '',
    preview: '', video_link: '', history_link: '',
    field1: '', field2: ''
  };
  STATE.data.push(newEp);
  selectEpisode(STATE.data.length - 1);
  renderList();
}

function duplicateEpisode() {
  if(STATE.selectedIdx === -1) return;
  const copy = JSON.parse(JSON.stringify(STATE.data[STATE.selectedIdx]));
  copy.title += ' (Копия)';
  copy.title_en += ' (Copy)';
  STATE.data.splice(STATE.selectedIdx + 1, 0, copy);
  selectEpisode(STATE.selectedIdx + 1);
  renderList();
}

function deleteEpisode() {
  // Using custom modal/confirmation is better than confirm() in iframes, but for simplicity:
  if(confirm('Удалить этот эпизод?')) {
    STATE.data.splice(STATE.selectedIdx, 1);
    STATE.selectedIdx = -1;
    renderList();
    // Clear form
    document.querySelectorAll('input, textarea').forEach(i => i.value = '');
  }
}

/* -------------------------------------------
   IO: Import/Export
   ------------------------------------------- */
function exportData() {
  const str = JSON.stringify(STATE.data, null, 2);
  const blob = new Blob([str], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = CONFIG.fileName;
  a.click();
}

function handleFileUpload(e) {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (evt) => {
    try {
      const parsedData = JSON.parse(evt.target.result);
      if (!Array.isArray(parsedData)) {
          throw new Error('File content is not a valid JSON array.');
      }
      STATE.data = parsedData;
      selectEpisode(0);
      renderList();
      showStatus(UI[STATE.locale].msgLoad, 'success');
    } catch(err) {
      showStatus(`Import Error: ${err.message}`, 'error');
    }
  };
  reader.readAsText(file);
}

/* -------------------------------------------
   IO: Gist (GitHub)
   ------------------------------------------- */
/* -------------------------------------------
   IO: Gist (GitHub) — load with token prompt + saved gistId use
   ------------------------------------------- */
async function loadFromGist() {
  // if a gist id already saved — use it silently, otherwise ask once
  const savedGist = localStorage.getItem('tl_gist_id');
  let gistId;
  if (savedGist && savedGist.trim() !== '') {
    gistId = savedGist;
  } else {
    gistId = prompt(`Enter Gist ID for ${CONFIG.fileName}:`, CONFIG.gistIdDefault);
    if (!gistId) return;
    localStorage.setItem('tl_gist_id', gistId);
  }

  // token: try saved token, otherwise prompt and save
  let token = localStorage.getItem('tl_gist_token');
  if (!token || !token.trim()) {
    token = prompt("Enter GitHub Personal Access Token (with 'gist' scope):");
    if (!token) {
      showStatus('GitHub token required to avoid rate limits.', 'error');
      return;
    }
    localStorage.setItem('tl_gist_token', token);
  }

  showStatus('Loading...', 'loading');

  try {
    const res = await fetch(`https://api.github.com/gists/${encodeURIComponent(gistId)}`, {
      headers: {
        "Accept": "application/vnd.github+json",
        "Authorization": `token ${token}`
      }
    });

    // Handle auth / rate / not found cases more helpfully
    if (res.status === 401 || res.status === 403 && res.headers.get('x-oauth-scopes') === null && res.headers.get('x-ratelimit-remaining') === '0') {
      // If unauthorized, clear token so user can re-enter next time
      localStorage.removeItem('tl_gist_token');
      throw new Error('Unauthorized or rate-limited. Token removed from storage — please try again with a valid token.');
    }

    if (res.status === 404) {
      throw new Error('Gist not found (404). Check the Gist ID.');
    }

    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }

    const json = await res.json();

    // check for file
    if (!json.files || !json.files[CONFIG.fileName]) {
      throw new Error(`File '${CONFIG.fileName}' not found in Gist.`);
    }

    // content may be returned in .content property
    const content = json.files[CONFIG.fileName].content;
    const parsed = JSON.parse(content);

    if (!Array.isArray(parsed)) {
      throw new Error('Gist content is not a valid JSON array.');
    }

    STATE.data = parsed;
    selectEpisode(0);
    renderList();
    showStatus(UI[STATE.locale].msgLoad, 'success');

  } catch (err) {
    console.error('Gist Load Error:', err);
    showStatus(`Load Failed: ${err.message}`, 'error');
  }
}

/* -------------------------------------------
   IO: Gist (GitHub) — save with token prompt + saved gistId use
   ------------------------------------------- */
async function saveToGist() {
  // token: try saved token, otherwise prompt and save
  let token = localStorage.getItem('tl_gist_token');
  if (!token || !token.trim()) {
    token = prompt("Enter GitHub Personal Access Token (with 'gist' scope):");
    if (!token) {
      showStatus('Save cancelled — token is required.', 'error');
      return;
    }
    localStorage.setItem('tl_gist_token', token);
  }

  // gistId: use saved if present, otherwise ask once
  let gistId = localStorage.getItem('tl_gist_id');
  if (!gistId || !gistId.trim()) {
    gistId = prompt('Enter Gist ID to save to:', CONFIG.gistIdDefault);
    if (!gistId) {
      showStatus('Save cancelled — gist id required.', 'error');
      return;
    }
    localStorage.setItem('tl_gist_id', gistId);
  }

  showStatus('Saving...', 'loading');

  const payload = {
    files: {
      [CONFIG.fileName]: {
        content: JSON.stringify(STATE.data, null, 2)
      }
    }
  };

  try {
    const res = await fetch(`https://api.github.com/gists/${encodeURIComponent(gistId)}`, {
      method: 'PATCH',
      headers: {
        'Accept': 'application/vnd.github+json',
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    // handle common error cases
    if (res.status === 401) {
      // invalid token — remove so user can re-enter next time
      localStorage.removeItem('tl_gist_token');
      throw new Error('Unauthorized (401). Token removed from storage — please re-enter a valid token.');
    }

    if (res.status === 404) {
      throw new Error('Gist not found (404). Check the Gist ID or create the Gist first.');
    }

    if (res.status === 403) {
      const rlRemaining = res.headers.get('x-ratelimit-remaining');
      if (rlRemaining === '0') {
        throw new Error('Rate limit exceeded. Try again later or use a different token.');
      }
      throw new Error('Forbidden (403). Check token scopes (need "gist").');
    }

    if (!res.ok) {
      const text = await res.text().catch(()=>'');
      throw new Error(`HTTP ${res.status}: ${res.statusText} ${text}`);
    }

    showStatus(UI[STATE.locale].msgSaved, 'success');
  } catch (err) {
    console.error('Gist Save Error:', err);
    showStatus(`Save Failed: ${err.message}`, 'error');
  }
}

function escapeHtml(text) {
  if(!text) return '';
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

</script>
</body>
</html>